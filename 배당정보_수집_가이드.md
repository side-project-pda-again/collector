# 배당 정보 수집 가이드

이 문서는 한국 및 미국 주식의 배당 정보를 수집하는 스크립트들의 사용법과 주요 로직을 설명합니다.

## 📁 파일 구조

```
stockproject/
├── dividend_export.py      # 개별 종목 배당 정보 수집
├── batch_dividends.py      # 종목 목록 기반 배당 정보 일괄 수집
└── requirements.txt        # 필요한 패키지 목록
```

## 🔧 사용된 라이브러리

### 공통 라이브러리
- **pandas**: 데이터 처리 및 CSV 저장
- **yfinance**: Yahoo Finance API를 통한 배당 데이터 수집
- **datetime**: 날짜 처리 및 변환

### 추가 라이브러리 (batch_dividends.py)
- **typing**: 타입 힌트 지원
- **os**: 파일 시스템 작업

## 💰 개별 종목 배당 수집 (dividend_export.py)

### 주요 기능
- 단일 종목의 배당 정보 수집
- 한국 주식 및 미국 주식 지원
- 지정된 기간의 배당 내역 조회
- CSV 형태로 배당 정보 저장

### 주요 로직 순서

1. **명령행 인자 파싱**
사용자가 원하는 종목과 기간을 유연하게 지정할 수 있도록 CLI 인터페이스 제공
   - `--ticker`: 종목코드 또는 티커 (예: 001720, AAPL)
   - `--market`: 시장 코드 (KOSPI/KOSDAQ/KONEX/US)
   - `--start`: 시작일 (YYYYMMDD)
   - `--end`: 종료일 (YYYYMMDD)
   - `--out`: 출력 파일명

2. **시장 코드에 따라 Yahoo 티커 접미사 반환**
   Yahoo Finance는 한국 주식에 시장 구분 접미사(.KS, .KQ)가 필요하지만, 미국 주식은 접미사가 없어서 시장별로 다른 티커 형식을 사용해야 함
   ```python
   # 한국 주식: 6자리 종목코드 + 접미사
   if market in ("KOSPI", "KS"): return "KS"
   if market in ("KOSDAQ", "KQ"): return "KQ"
   
   # 미국 주식: 접미사 없음
   if market == "US": return ""
   ```

3. **yfinance를 통한 배당 데이터 수집**
yfinance는 한국/미국 주식 모두 지원하므로 통일된 방식으로 배당 데이터 수집 가능
   ```python
   tk = yf.Ticker(yf_ticker)
   divs = tk.dividends
   
   # 기간 필터링
   mask = (divs.index.date >= start) & (divs.index.date <= end)
   sel = divs.loc[mask]
   ```   

4. **데이터 정리 및 저장**
   - 배당금 정수/실수 처리: 정수인 경우 소수점 제거하여 가독성 향상
   - 날짜 형식 변환 (YYYY.M.D): 한국식 날짜 표기법으로 통일
   - CSV 저장: UTF-8-SIG 인코딩으로 Excel에서 한글 정상 표시
   

### 사용법

```bash
# 한국 주식 배당 수집
python3 dividend_export.py --ticker 005930 --market KOSPI --start 20200101 --end 20241231 --out samsung_dividends.csv

# 미국 주식 배당 수집
python3 dividend_export.py --ticker AAPL --market US --start 20200101 --end 20241231 --out apple_dividends.csv

# ETF 배당 수집
python3 dividend_export.py --ticker TSLY --market US --start 20240101 --end 20250801 --out tsly_dividends.csv
```

### 출력 데이터 형식

| 컬럼명 | 설명 | 예시 |
|--------|------|------|
| ISCD | 종목코드 | 005930 |
| 기준일 | 배당 기준일 | 2024.3.15 |
| 배당금 | 배당 금액 | 500 |

## 🔄 일괄 배당 수집 (batch_dividends.py)

### 주요 기능
- 종목 목록 CSV 파일 기반 일괄 배당 수집
- 행 범위 지정으로 부분 처리 지원
- 특정 종목만 선별 처리 가능
- 진행 상황 실시간 표시
- 기존 파일에 이어쓰기 지원

### 주요 로직 순서

1. **명령행 인자 파싱**
대량 종목 처리 시 유연한 제어가 필요하므로 다양한 필터링 옵션 제공
   - `--in`: 입력 CSV 파일 (krx_export.py - 종목 정보 파일)
   - `--out`: 출력 CSV 파일
   - `--start`: 시작일 (YYYYMMDD)
   - `--end`: 종료일 (YYYYMMDD)
   - `--only`: 특정 종목코드만 처리
   - `--row-start`: 처리 시작 행
   - `--row-end`: 처리 종료 행

2. **입력 데이터 로드 및 필터링**
   ```python
   # CSV 로드: 종목코드를 문자열로 읽어 0으로 시작하는 코드 보존
   src = pd.read_csv(args.infile, dtype={"ISCD": str, "KR_ISNM": str, "MARKET": str})
   ```

3. **종목별 배당 수집**
   ```python
   #종목코드를 6자리로 맞춰 Yahoo Finance 형식에 맞춤
   for idx, row in src.iterrows():
       iscd = str(row.get("ISCD", "")).zfill(6)
       market = row.get("MARKET", "")
       
       # 시장 코드 변환 (KOSPI -> KS, KOSDAQ -> KQ)
       mapped = market_to_de_market(market)
       
       # 배당 정보 수집
       df = de.fetch_dividends_yf(iscd, mapped, start_d, end_d)
   ```

4. **결과 통합 및 저장**
   - 모든 종목의 배당 데이터 통합
   - 종목코드, 기준일 순으로 정렬
   - 기존 파일에 이어쓰기 또는 새 파일 생성

### 사용법

```bash
# 전체 종목 배당 수집
python3 batch_dividends.py --in kr_stocks_etfs.csv --out kr_dividends.csv --start 20200101 --end 20241231

# 행 범위 지정 (--row-start, --row-end 옵션)
python3 batch_dividends.py --in kr_stocks_etfs.csv --row-start 2001 --row-end 3782 --start 20200101 --end 20241231 --out kr_divs.csv

# 특정 종목만 수집 (--only 옵션)
python3 batch_dividends.py --in kr_stocks_etfs.csv --only 005930,000660 --out selected_dividends.csv
```

### 대용량 데이터 분할 처리 예시

```bash
# 1단계: 1~1000행 처리 (2020~2024년 배당)
python3 batch_dividends.py --in kr_stocks_etfs.csv --row-start 1 --row-end 1000 --start 20200101 --end 20241231 --out kr_dividends.csv

# 2단계: 1001~2000행 처리 (같은 파일에 추가됨)
python3 batch_dividends.py --in kr_stocks_etfs.csv --row-start 1001 --row-end 2000 --start 20200101 --end 20241231 --out kr_dividends.csv

# 3단계: 2001~3000행 처리 (같은 파일에 추가됨)
python3 batch_dividends.py --in kr_stocks_etfs.csv --row-start 2001 --row-end 3000 --start 20200101 --end 20241231 --out kr_dividends.csv
```

**결과**: `kr_dividends.csv` 파일에 3000개 종목의 2020~2024년 배당 정보가 모두 누적되어 저장됩니다.

### 출력 데이터 형식

| 컬럼명 | 설명 | 예시 |
|--------|------|------|
| ISCD | 종목코드 | 005930 |
| 기준일 | 배당 기준일 | 2024.3.15 |
| 배당금 | 배당 금액 | 500 |
| KR_ISNM | 종목명 | 삼성전자 |
| MARKET | 시장구분 | KOSPI |
